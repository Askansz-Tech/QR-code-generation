<!DOCTYPE html>
<html>
<head>
  <title>Meshtastic H1 Bluetooth Tool</title>
</head>
<body>
  <h1>Meshtastic Web Bluetooth Interface</h1>
  <button id="connect">Connect to H1</button><br><br>
  <textarea id="log" rows="10" cols="50" readonly></textarea><br>
  <input type="text" id="messageInput" placeholder="Enter message">
  <button id="send">Send</button>

  <script>
    let bluetoothDevice;
    let txCharacteristic;

    const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e'; // Nordic UART Service UUID
    const TX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // TX from phone to H1
    const RX_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // RX from H1 to phone

    document.getElementById('connect').onclick = async () => {
      try {
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });

        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        txCharacteristic = await service.getCharacteristic(TX_UUID);
        const rxCharacteristic = await service.getCharacteristic(RX_UUID);

        await rxCharacteristic.startNotifications();
        rxCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
          const value = new TextDecoder().decode(event.target.value);
          document.getElementById('log').value += value + "\n";
        });

        log("Connected to Meshtastic H1!");
      } catch (error) {
        log("Connection failed: " + error);
      }
    };

    document.getElementById('send').onclick = async () => {
      const msg = document.getElementById('messageInput').value;
      if (txCharacteristic && msg) {
        const encoded = new TextEncoder().encode(msg + "\n");
        await txCharacteristic.writeValue(encoded);
        log("Sent: " + msg);
      }
    };

    function log(msg) {
      document.getElementById('log').value += msg + "\n";
    }
  </script>
</body>
</html>
